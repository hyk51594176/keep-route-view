"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var Core=function(){function e(){_classCallCheck(this,e),this.contextMap=new Map,this.includeList=new Set,this.unWatch=null,this.router=null}return _createClass(e,[{key:"bindVm",value:function(e){if(!this.router){if(!e.parent.$router)throw new Error("请在使用该组件前安装vueRouter");this.router=e.parent.$router,window.addEventListener("popstate",this.directionChange.bind(this,"back")),this.init()}this.contextMap.has(e.parent)||(this.contextMap.set(e.parent,e),e.parent.$on("hook:beforeDestroy",this.unBindVm.bind(this,e)))}},{key:"init",value:function(){var n=this;["push","replace","back"].forEach(function(e){var t=n.router[e].bind(n.router);n.router[e]=function(){n.directionChange(e),t.apply(void 0,arguments)}}),this.unWatch=this.router.afterEach(function(e,t){"back"===n.direction||"replace"===n.direction?t.matched.forEach(function(e){var t=e.components.default.name;n.includeList.has(t)&&n.includeList.delete(t)}):e.matched.forEach(function(e){var t=e.components.default;!t.name||t.noKeep||n.includeList.has(t.name)||n.includeList.add(t.name)}),n.includeChange()})}},{key:"unBindVm",value:function(e){this.contextMap.delete(e),0===this.contextMap.size&&(this.unWatch(),this.router=null,this.direction="",window.removeEventListener("popstate",this.updateDirection.bind(this)))}},{key:"directionChange",value:function(t){this.direction=t,this.contextMap.forEach(function(e){e.listeners.change&&e.listeners.change(t)})}},{key:"includeChange",value:function(){var t=this;this.contextMap.forEach(function(e){e.listeners.includeChange&&e.listeners.includeChange([].concat(_toConsumableArray(e.props.include||[]),_toConsumableArray(t.includeList)))})}}]),e}(),core=new Core,KeepRouteView={functional:!0,name:"KeepRouteView",props:{include:[String,Array,RegExp],exclude:[String,Array,RegExp],max:{type:Number,default:10}},render:function(e,t){core.bindVm(t);var n=[].concat(_toConsumableArray(core.includeList),_toConsumableArray(t.props.include||[]));return e("keep-alive",{props:_objectSpread({},t.props,{include:n})},[e("router-view",t.data,t.children)])}};function install(e){install.Installed||(e.component(KeepRouteView.name,KeepRouteView),install.Installed=!0)}module.exports=install;
